<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard 3C Plus</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100vh; font-family: Arial, sans-serif; background: #f8f9fa; }
    body { display: flex; flex-direction: column; padding: 0 20px 20px 20px; }
    #mensagemStatus { font-weight: bold; font-size: 22px; margin: 12px 0 16px; }

    /* ---- Cart√µes ---- */
    .linha-top {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      margin-bottom: 12px;
      gap: 12px;
    }
    .linha-meio {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 10px;
    }
    .cartao {
      background: #fff;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
    }
    .cartao strong { font-size: 22px; color: #222; }
    .cartao div { font-size: 24px; font-weight: bold; margin-top: 6px; }
    .cartao-central { grid-column: 2; }

    .cor-verde{background:#d1e7dd;}
    .cor-azul{background:#cff4fc;}
    .cor-laranja{background:#fce5cd;}

    /* ---- Gr√°ficos ---- */
    .graficos-wrapper{
      display:flex; gap:20px; margin-top:10px;
      flex:1; min-height:0;
    }
    .grafico-container{
      background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,.1);
      display:flex; flex-direction:column; overflow:visible;
      flex:1; min-height:0;
    }
    .grafico-container h2 { font-size: 26px; margin-bottom: 10px; }
    canvas { flex:1; width:100% !important; height:100% !important; min-height:0; }

    #btnAnterior { position: fixed; top: 15px; right: 25px; background: #0d6efd; color: #fff; padding: 10px 18px; border-radius: 8px; font-weight: bold; text-decoration: none; box-shadow: 0 2px 6px rgba(0,0,0,.25); }
    #btnAnterior:hover { background:#084298; }
  </style>
</head>
<body>
  <a href="/previous" id="btnAnterior">‚Üê Per√≠odo anterior</a>
  <div id="mensagemStatus">Carregando...</div>

  <!-- Linha 1 -->
  <div class="linha-top">
    <div class="cartao cartao-central cor-verde">
      <strong>üëë Top convers√£o da semana</strong>
      <div id="topConversaoSemana">-</div>
    </div>
  </div>

  <!-- Linha 2 -->
  <div class="linha-meio">
    <div class="cartao cor-azul">
      <strong>üèÜ Top Agente convers√£o no m√™s</strong>
      <div id="topVendasMes">-</div>
    </div>
    <div class="cartao cor-laranja">
      <strong>üìû Sdr mais intenso da semana </strong>
      <div id="topLigacoesSemana">-</div>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div class="graficos-wrapper">
    <div class="grafico-container">
      <h2>Top 5 ‚Äî Convers√µes hoje</h2>
      <canvas id="graficoVendasHoje"></canvas>
    </div>
    <div class="grafico-container">
      <h2>Top 5 ‚Äî Liga√ß√µes hoje</h2>
      <canvas id="graficoLigacoesHoje"></canvas>
    </div>
  </div>

  <script>
    let chartVendasHoje = null;
    let chartLigacoesHoje = null;

    async function carregarResumo() {
      const msg = document.getElementById("mensagemStatus");
      try {
        const r = await fetch("/api/resumo");
        const data = await r.json();

        document.getElementById("topConversaoSemana").textContent =
          `${data.agente_venda_semana} (${data.vendas_semana_agente})`;

        document.getElementById("topVendasMes").textContent =
          `${data.agente_venda_mes} (${data.vendas_mes_agente})`;

        document.getElementById("topLigacoesSemana").textContent =
          `${data.agente_ligacao_semana} (${data.ligacoes_semana_agente})`;

        msg.textContent = "üìä Dados atualizados na tela.";
        msg.style.color = "green";
      } catch (e) {
        console.error(e);
        msg.textContent = "‚ùå Falha ao atualizar dados.";
        msg.style.color = "red";
      }
    }

    async function carregarGraficosDia() {
      if (chartVendasHoje) chartVendasHoje.destroy();
      if (chartLigacoesHoje) chartLigacoesHoje.destroy();

      try {
        const resp = await fetch("/api/graficos");
        const dados = await resp.json();

        // Convers√µes
        const nomesVendasHoje = dados.top_vendas_hoje.map(i => i[0]);
        const vendasHoje = dados.top_vendas_hoje.map(i => i[1]);

        // Liga√ß√µes empilhadas
        const stk = (dados.top_ligacoes_hoje_stack || []).filter(x => x.total > 0);
        const nomesLigHoje = stk.map(x => x.agente);
        const totalLig = stk.map(x => x.total);
        const longLig = stk.map(x => x.acima_110);
        const shortLig = totalLig.map((t, i) => Math.max(t - longLig[i], 0));

        const optionsBase = {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 24, bottom: 40 } },
          plugins: { legend: { display: false } },
          scales: {
            x: {
              ticks:{ font:{ size:16 }, padding:10 },
              grid:{ display:false }
            },
            y: {
              beginAtZero:true,
              grace: '25%',
              ticks:{ font:{ size:16 }},
              grid:{ display:false }
            }
          }
        };

        // ===== Gr√°fico Convers√µes =====
        chartVendasHoje = new Chart(
          document.getElementById("graficoVendasHoje").getContext("2d"),
          {
            type: "bar",
            data: {
              labels: nomesVendasHoje,
              datasets: [{
                label: "Convers√µes (hoje)",
                data: vendasHoje,
                backgroundColor: [
                  'rgba(173,216,230,0.9)',
                  'rgba(75,192,75,0.9)',
                  'rgba(255,206,86,0.9)',
                  'rgba(0,123,255,0.9)',
                  'rgba(153,102,255,0.9)'
                ].slice(0, vendasHoje.length)
              }]
            },
            options: {
              ...optionsBase,
              plugins: {
                ...optionsBase.plugins,
                datalabels: {
                  display: true,
                  anchor: 'end',
                  align: 'top',
                  offset: 6,
                  backgroundColor:'#fff9c4',
                  borderRadius:6,
                  borderWidth:1,
                  borderColor:'#ccc',
                  padding:{top:6,bottom:6,left:10,right:10},
                  color:'#000',
                  font:{weight:'bold', size:24}, // üëà Aumentei para 24px
                  formatter:v=>v
                }
              }
            },
            plugins: [ChartDataLabels]
          }
        );

        // ===== Plugin valores (para o gr√°fico de liga√ß√µes) =====
        const pluginValores = {
          id: 'pluginValores',
          afterDatasetsDraw(chart) {
            const { ctx, data, scales: { x, y } } = chart;
            const dsOrange = data.datasets[0];
            const dsBlue = data.datasets[1];

            const drawBadge = (text, xCenter, yBottom, offset = 4, fontSize = 22) => {
              ctx.font = `bold ${fontSize}px Arial`;
              const w = ctx.measureText(text).width + 14;
              const h = fontSize + 6;
              const r = 6;
              const x0 = Math.round(xCenter - w / 2);
              const y0 = Math.round(yBottom - h - offset);

              ctx.beginPath();
              ctx.moveTo(x0 + r, y0);
              ctx.arcTo(x0 + w, y0, x0 + w, y0 + h, r);
              ctx.arcTo(x0 + w, y0 + h, x0, y0 + h, r);
              ctx.arcTo(x0, y0 + h, x0, y0, r);
              ctx.arcTo(x0, y0, x0 + w, y0, r);
              ctx.closePath();
              ctx.fillStyle = '#fff5bf';
              ctx.fill();
              ctx.strokeStyle = '#d9cf95';
              ctx.lineWidth = 1;
              ctx.stroke();

              ctx.fillStyle = '#000';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText(text, x0 + w / 2, y0 + h / 2 + .5);
            };

            ctx.save();
            data.labels.forEach((_, i) => {
              const xPos = x.getPixelForValue(i);
              const orangeVal = dsOrange.data[i] || 0;
              const blueVal = dsBlue.data[i] || 0;
              const total = orangeVal + blueVal;

              const yTopOrange = y.getPixelForValue(orangeVal);
              if (orangeVal > 0) drawBadge(String(orangeVal), xPos, yTopOrange, 4, 20); // üëà >1:50 aumentado
              const yTopTotal = y.getPixelForValue(total);
              drawBadge(String(total), xPos, yTopTotal, 12, 26); // üëà total aumentado
            });
            ctx.restore();
          }
        };

        // ===== Gr√°fico Liga√ß√µes =====
        chartLigacoesHoje = new Chart(
          document.getElementById("graficoLigacoesHoje").getContext("2d"),
          {
            type: "bar",
            data: {
              labels: nomesLigHoje,
              datasets: [
                { label: '> 1:50', data: longLig,  backgroundColor: 'rgba(255,206,86,0.9)', stack: 'calls' },
                { label: '‚â§ 1:50', data: shortLig, backgroundColor: 'rgba(173,216,230,0.9)', stack: 'calls' }
              ]
            },
            options: {
              ...optionsBase,
              layout: { padding: { top: 50, bottom: 20 } },
              scales: {
                x: { ...optionsBase.scales.x, stacked: true },
                y: { ...optionsBase.scales.y, stacked: true }
              },
              plugins: { ...optionsBase.plugins, datalabels: { display: false } }
            },
            plugins: [pluginValores]
          }
        );

      } catch (e) {
        console.error("Erro ao carregar gr√°ficos:", e);
      }
    }

    async function iniciar() {
      fetch("/api/pegar").catch(()=>{});
      await Promise.all([carregarResumo(), carregarGraficosDia()]);
      setInterval(async () => {
        fetch("/api/pegar").catch(()=>{});
        await Promise.all([carregarResumo(), carregarGraficosDia()]);
      }, 60000);
    }
    iniciar();
  </script>
</body>
</html>
