<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard 3C Plus ‚Äì Per√≠odo Anterior</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;height:100vh;font-family:Arial,sans-serif;background:#f8f9fa;}
    body{display:flex;flex-direction:column;padding:0 20px 20px 20px;}
    #mensagemStatus{font-weight:bold;font-size:22px;margin-bottom:20px;}

    /* ---- Cart√µes (layout novo) ---- */
    .linha-top{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      margin-bottom:12px; gap:12px;
    }
    .linha-meio{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px; margin-bottom:10px;
    }
    .cartao{
      background:#fff;padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.1);
      height:100px;display:flex;flex-direction:column;justify-content:center;text-align:center;
    }
    .cartao strong{font-size:22px;color:#222;}
    .cartao div{font-size:24px;font-weight:bold;margin-top:6px;}
    .cartao-central{grid-column:2;} /* centralizado na coluna do meio */

    .cor-verde{background:#d1e7dd;} .cor-azul{background:#cff4fc;} .cor-laranja{background:#fce5cd;}

    /* ---- Gr√°ficos ---- */
    .graficos-wrapper{
      display:flex; gap:20px; margin-top:10px;
      /* ocupar o espa√ßo restante da tela */
      flex:1; min-height:0;
    }
    .grafico-container{
      background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1);
      display:flex;flex-direction:column;overflow:hidden;flex:1;min-height:0;
    }
    .grafico-container h2{font-size:26px;margin-bottom:10px;}
    canvas{flex:1;width:100%!important;height:100%!important;min-height:0;}

    #btnPrincipal{
      position:fixed;top:15px;right:25px;background:#0d6efd;color:#fff;
      padding:10px 18px;border-radius:8px;font-weight:bold;text-decoration:none;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    #btnPrincipal:hover{background:#084298;}
  </style>
</head>
<body>
  <a href="/" id="btnPrincipal">‚Üê Voltar ao atual</a>

  <div id="mensagemStatus">Carregando‚Ä¶</div>

  <!-- Linha 1: cart√£o √∫nico centralizado -->
  <div class="linha-top">
    <div class="cartao cartao-central cor-verde">
      <strong>üëë Top convers√£o da semana passada</strong>
      <div id="topConversaoSemanaPassada">-</div>
    </div>
  </div>

  <!-- Linha 2: dois cart√µes lado a lado -->
  <div class="linha-meio">
    <div class="cartao cor-azul">
      <strong>üèÜ Top vendas no m√™s passado</strong>
      <div id="topVendasMesPassado">-</div>
    </div>
    <div class="cartao cor-laranja">
      <strong>üìû Top liga√ß√µes na semana passada</strong>
      <div id="topLigacoesSemanaPassada">-</div>
    </div>
  </div>

  <!-- Gr√°ficos (ONTEM) -->
  <div class="graficos-wrapper">
    <div class="grafico-container">
      <h2>Top 5 ‚Äî Vendas ontem</h2>
      <canvas id="graficoVendasOntem"></canvas>
    </div>
    <div class="grafico-container">
      <h2>Top 5 ‚Äî Liga√ß√µes ontem</h2>
      <canvas id="graficoLigacoesOntem"></canvas>
    </div>
  </div>

  <script>
    let chartVendasOntem = null;
    let chartLigacoesOntem = null;

    const esperar = ms => new Promise(r=>setTimeout(r,ms));

    async function pegarDados(){
      const msg=document.getElementById("mensagemStatus");
      msg.style.color="black"; msg.textContent="‚è≥ Buscando dados da API‚Ä¶";
      try{
        const r=await fetch("/api/pegar"); const j=await r.json();
        if (j.status==="ok") {
          msg.style.color="green"; msg.textContent="üì¶ Dados em cache prontos.";
        } else {
          msg.style.color="red"; msg.textContent="‚ö†Ô∏è Erro: "+(j.erro||"desconhecido");
        }
      }catch(e){
        msg.style.color="red"; msg.textContent="‚ùå Erro na requisi√ß√£o."; console.error(e);
      }
    }

    /* -------- Cart√µes (novos campos do backend com ?prev) -------- */
    async function carregarResumoPrev(){
      try{
        const r=await fetch("/api/resumo?prev");
        const d=await r.json();

        document.getElementById("topConversaoSemanaPassada").textContent =
          `${d.agente_venda_semana} (${d.vendas_semana_agente})`;

        document.getElementById("topVendasMesPassado").textContent =
          `${d.agente_venda_mes} (${d.vendas_mes_agente})`;

        document.getElementById("topLigacoesSemanaPassada").textContent =
          `${d.agente_ligacao_semana} (${d.ligacoes_semana_agente})`;

        const msg = document.getElementById("mensagemStatus");
        msg.textContent = "üìä Dados exibidos.";
        msg.style.color = "green";
      }catch(e){
        console.error(e);
        const msg = document.getElementById("mensagemStatus");
        msg.textContent = "‚ùå Falha ao carregar cart√µes.";
        msg.style.color = "red";
      }
    }

    /* -------- Gr√°ficos: ontem (usa /api/graficos?prev) -------- */
    async function carregarGraficosOntem(){
      if (chartVendasOntem) chartVendasOntem.destroy();
      if (chartLigacoesOntem) chartLigacoesOntem.destroy();

      try{
        const r=await fetch("/api/graficos?prev");
        const d=await r.json();

        // OBS: no backend novo, mesmo com ?prev, as chaves s√£o *_hoje (mas referem-se a ontem)
        const nomesV = d.top_vendas_hoje.map(x=>x[0].split(" ")[0]);
        const vendas = d.top_vendas_hoje.map(x=>x[1]);

        const nomesL = d.top_ligacoes_hoje.map(x=>x[0].split(" ")[0]);
        const lig    = d.top_ligacoes_hoje.map(x=>x[1]);

        const cores = [
          'rgba(173,216,230,.9)','rgba(75,192,75,.9)','rgba(255,206,86,.9)',
          'rgba(0,123,255,.9)','rgba(153,102,255,.9)'
        ];

        const opts = {
          responsive:true, maintainAspectRatio:false,
          layout:{padding:{top:30,bottom:50}},
          plugins:{
            legend:{display:false},
            datalabels:{
              anchor:'end', align:'end', backgroundColor:'#fff9c4',
              borderRadius:6,borderWidth:1,borderColor:'#ccc',
              padding:{top:6,bottom:6,left:10,right:10}, color:'#000',
              font:{weight:'bold',size:18}, formatter:v=>v
            }
          },
          scales:{
            x:{ticks:{font:{size:20},maxRotation:10,minRotation:10,padding:10},grid:{display:false}},
            y:{beginAtZero:true,ticks:{font:{size:16}},grid:{display:false}}
          }
        };

        chartVendasOntem = new Chart(document.getElementById("graficoVendasOntem").getContext("2d"),{
          type:"bar",
          data:{labels:nomesV,datasets:[{label:"Vendas (ontem)",data:vendas,backgroundColor:cores.slice(0,vendas.length)}]},
          options:opts, plugins:[ChartDataLabels]
        });

        chartLigacoesOntem = new Chart(document.getElementById("graficoLigacoesOntem").getContext("2d"),{
          type:"bar",
          data:{labels:nomesL,datasets:[{label:"Liga√ß√µes (ontem)",data:lig,backgroundColor:cores.slice(0,lig.length)}]},
          options:opts, plugins:[ChartDataLabels]
        });

      }catch(e){
        console.error(e);
        const msg = document.getElementById("mensagemStatus");
        msg.textContent = "‚ùå Falha ao carregar gr√°ficos.";
        msg.style.color = "red";
      }
    }

    async function atualizarTudoPrev(){
      await carregarResumoPrev();
      await carregarGraficosOntem();
    }

    async function iniciarAtualizacaoAnterior(){
      await pegarDados();
      await esperar(1200);
      await atualizarTudoPrev();
      setInterval(atualizarTudoPrev, 60000);
    }

    iniciarAtualizacaoAnterior();
  </script>
</body>
</html>
