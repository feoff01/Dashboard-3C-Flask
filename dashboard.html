<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard 3C Plus</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <style>
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100vh; font-family: Arial, sans-serif; background: #f8f9fa; }
    body { display: flex; flex-direction: column; padding: 0 20px 20px 20px; }
    h1 { color: #111; font-size: 42px; margin-bottom: 15px; }
    #mensagemStatus { font-weight: bold; font-size: 22px; margin-bottom: 20px; }

    /* ---- Cart√µes ---- */
    .linha-top {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      margin-bottom: 12px;
      gap: 12px;
    }
    .linha-meio {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 10px;
    }
    .cartao {
      background: #fff;
      padding: 14px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
    }
    .cartao strong { font-size: 22px; color: #222; }
    .cartao div { font-size: 24px; font-weight: bold; margin-top: 6px; }
    .cartao-central { grid-column: 2; } /* centraliza na coluna do meio */

    .cor-verde{background:#d1e7dd;}
    .cor-azul{background:#cff4fc;}
    .cor-laranja{background:#fce5cd;}

    /* ---- Gr√°ficos ---- */
    .graficos-wrapper {
      display: flex;
      gap: 20px;
      margin-top: 10px;

      /* Ocupa todo o espa√ßo restante da viewport */
      flex: 1;
      min-height: 0; /* evita overflow interno */
    }
    .grafico-container {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex: 1;
      min-height: 0;
    }
    .grafico-container h2 { font-size: 26px; margin-bottom: 10px; }
    canvas {
      flex: 1;
      width: 100% !important;
      height: 100% !important;
      min-height: 0;
    }

    #btnAnterior { position: fixed; top: 15px; right: 25px; background: #0d6efd; color: #fff; padding: 10px 18px; border-radius: 8px; font-weight: bold; text-decoration: none; box-shadow: 0 2px 6px rgba(0,0,0,.25); }
    #btnAnterior:hover { background:#084298; }
  </style>
</head>
<body>
  <a href="/previous" id="btnAnterior">‚Üê Per√≠odo anterior</a>
  <div id="mensagemStatus">Carregando...</div>

  <!-- Linha 1: cart√£o √∫nico centralizado -->
  <div class="linha-top">
    <div class="cartao cartao-central cor-verde">
      <strong>üëë Top convers√£o da semana</strong>
      <div id="topConversaoSemana">-</div>
    </div>
  </div>

  <!-- Linha 2: dois cart√µes lado a lado -->
  <div class="linha-meio">
    <div class="cartao cor-azul">
      <strong>üèÜ Top Agente convers√£o no m√™s</strong>
      <div id="topVendasMes">-</div>
    </div>
    <div class="cartao cor-laranja">
      <strong>üìû Top liga√ß√µes na semana</strong>
      <div id="topLigacoesSemana">-</div>
    </div>
  </div>

  <!-- Gr√°ficos (DO DIA) -->
  <div class="graficos-wrapper">
    <div class="grafico-container">
      <h2>Top 5 ‚Äî Convers√µes hoje</h2>
      <canvas id="graficoVendasHoje"></canvas>
    </div>
    <div class="grafico-container">
      <h2>Top 5 ‚Äî Liga√ß√µes hoje</h2>
      <canvas id="graficoLigacoesHoje"></canvas>
    </div>
  </div>

  <script>
    let chartVendasHoje = null;
    let chartLigacoesHoje = null;

    async function pegarDados() {
      const msg = document.getElementById("mensagemStatus");
      msg.style.color = "black";
      msg.textContent = "‚è≥ Buscando dados da API...";
      try {
        const resp = await fetch("/api/pegar");
        const json = await resp.json();

        if (json.status === "ok" && json.parcial) {
          msg.style.color = "#8a6d3b";
          msg.textContent = "‚ö†Ô∏è Dados atualizados parcialmente (algumas janelas expiraram).";
        } else if (json.status === "ok") {
          msg.style.color = "green";
          msg.textContent = "üìä Dados atualizados na tela.";
        } else {
          msg.style.color = "red";
          msg.textContent = "‚ö†Ô∏è Erro ao buscar dados: " + (json.erro || "erro desconhecido");
        }
      } catch (e) {
        msg.style.color = "red";
        msg.textContent = "‚ùå Erro na requisi√ß√£o.";
        console.error(e);
      }
    }

    async function carregarResumo() {
      try {
        const resp   = await fetch("/api/resumo");
        const r = await resp.json();

        // Cart√£o 1: Top convers√£o da semana
        document.getElementById("topConversaoSemana").textContent =
          `${r.agente_venda_semana} (${r.vendas_semana_agente})`;

        // Cart√£o 2: Top vendas no m√™s
        document.getElementById("topVendasMes").textContent =
          `${r.agente_venda_mes} (${r.vendas_mes_agente})`;

        // Cart√£o 3: Top liga√ß√µes na semana
        document.getElementById("topLigacoesSemana").textContent =
          `${r.agente_ligacao_semana} (${r.ligacoes_semana_agente})`;

        const msg = document.getElementById("mensagemStatus");
        msg.textContent = "üìä Dados atualizados na tela.";
        msg.style.color = "green";
      } catch (e) {
        console.error("Erro ao carregar resumo:", e);
        document.getElementById("mensagemStatus").textContent = "‚ùå Falha ao atualizar os dados na tela.";
        document.getElementById("mensagemStatus").style.color = "red";
      }
    }

    async function carregarGraficosDia() {
      if (chartVendasHoje) chartVendasHoje.destroy();
      if (chartLigacoesHoje) chartLigacoesHoje.destroy();

      try {
        const resp = await fetch("/api/graficos");
        const dados = await resp.json();

        const nomesVendasHoje = dados.top_vendas_hoje.map(i => i[0].split(" ")[0]);
        const vendasHoje = dados.top_vendas_hoje.map(i => i[1]);

        const nomesLigHoje = dados.top_ligacoes_hoje.map(i => i[0].split(" ")[0]);
        const ligHoje = dados.top_ligacoes_hoje.map(i => i[1]);

        const cores = [
          'rgba(173, 216, 230, 0.9)',
          'rgba(75, 192, 75, 0.9)',
          'rgba(255, 206, 86, 0.9)',
          'rgba(0, 123, 255, 0.9)',
          'rgba(153, 102, 255, 0.9)'
        ];

        const optionsBase = {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 30, bottom: 50 } },
          plugins: {
            legend: { display: false },
            datalabels: {
              anchor:'end', align:'end', backgroundColor:'#fff9c4',
              borderRadius:6, borderWidth:1, borderColor:'#ccc',
              padding:{top:6,bottom:6,left:10,right:10}, color:'#000',
              font:{weight:'bold', size:18}, formatter:v=>v
            }
          },
          scales: {
            x: { ticks:{ font:{ size:20 }, maxRotation:10, minRotation:10, padding:10 }, grid:{ display:false }},
            y: { beginAtZero:true, ticks:{ font:{ size:16 }}, grid:{ display:false } }
          }
        };

        chartVendasHoje = new Chart(document.getElementById("graficoVendasHoje").getContext("2d"), {
          type: "bar",
          data: { labels: nomesVendasHoje, datasets: [{ label: "Convers√ß√µes (hoje)", data: vendasHoje, backgroundColor: cores.slice(0, vendasHoje.length) }] },
          options: optionsBase,
          plugins: [ChartDataLabels]
        });

        chartLigacoesHoje = new Chart(document.getElementById("graficoLigacoesHoje").getContext("2d"), {
          type: "bar",
          data: { labels: nomesLigHoje, datasets: [{ label: "Liga√ß√µes (hoje)", data: ligHoje, backgroundColor: cores.slice(0, ligHoje.length) }] },
          options: optionsBase,
          plugins: [ChartDataLabels]
        });

      } catch (e) {
        console.error("Erro ao carregar dados dos gr√°ficos:", e);
      }
    }

    function atualizarTudo() {
      carregarResumo();
      carregarGraficosDia();
    }

    const esperar = ms => new Promise(r => setTimeout(r, ms));

    async function iniciarAtualizacaoAutomatica() {
      await esperar(2000);
      await pegarDados();
      await esperar(1500);
      atualizarTudo();
      while (true) {
        await esperar(60000);
        await pegarDados();
        await esperar(1500);
        atualizarTudo();
      }
    }

    iniciarAtualizacaoAutomatica();
  </script>
</body>
</html>
